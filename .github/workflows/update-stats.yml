name: Update Language Statistics

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/update-stats.yml'
      - 'generate_stats.py'

jobs:
  update-language-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: 📦 Install dependencies
      run: |
        pip install requests
    
    - name: 📊 Generate language statistics
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
      run: |
        echo "🔍 Starting language statistics generation..."
        echo "Repository owner: $GITHUB_REPOSITORY_OWNER"
        echo "Token length: ${#GITHUB_TOKEN}"
        
        python generate_stats.py || {
          echo "❌ Python script failed"
          echo "Checking if generate_stats.py exists:"
          ls -la generate_stats.py
          echo "Python version:"
          python --version
          exit 1
        }
        
        # Check if files were created
        if [ ! -f language_stats.svg ]; then
          echo "❌ Error: language_stats.svg was not created"
          echo "Current directory contents:"
          ls -la
          exit 1
        fi
        
        echo "✅ Language statistics generated successfully"
    
    - name: 📝 Update README with stats
      run: |
        # Check if README.md exists
        if [ ! -f README.md ]; then
          echo "# ${{ github.repository_owner }}" > README.md
          echo "" >> README.md
          echo "<!-- LANGUAGE_STATS_START -->" >> README.md
          echo "<!-- LANGUAGE_STATS_END -->" >> README.md
        fi
        
        # Create temporary file with new content
        cat > temp_stats.md << 'EOF'
        <!-- LANGUAGE_STATS_START -->
        
        ![Language Statistics](./language_stats.svg)
        
        *Updated automatically every Sunday*
        
        <!-- LANGUAGE_STATS_END -->
        EOF
        
        # Update the language stats section in README.md
        if grep -q "<!-- LANGUAGE_STATS_START -->" README.md; then
          # Replace existing section
          sed -i '/<!-- LANGUAGE_STATS_START -->/,/<!-- LANGUAGE_STATS_END -->/d' README.md
          cat temp_stats.md >> README.md
        else
          # Add new section at the end
          echo "" >> README.md
          cat temp_stats.md >> README.md
        fi
        
        # Clean up
        rm temp_stats.md
    
    - name: 📈 Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check what files exist before adding
        echo "📁 Files in directory:"
        ls -la
        
        # Add files that exist
        git add README.md
        
        if [ -f language_stats.svg ]; then
          git add language_stats.svg
          echo "✅ Added language_stats.svg"
        fi
        
        if [ -f language_stats.json ]; then
          git add language_stats.json
          echo "✅ Added language_stats.json"
        fi
        
        if [ -f language_stats.md ]; then
          git add language_stats.md
          echo "✅ Added language_stats.md"
        fi
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "ℹ️ No changes to commit"
        else
          git commit -m "📊 Update language statistics"
          git push
          echo "✅ Changes committed and pushed"
        fi
    
    - name: 📋 Create job summary
      run: |
        echo "## 📊 Language Statistics Updated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
        echo "- 📄 language_stats.svg" >> $GITHUB_STEP_SUMMARY
        echo "- 📊 language_stats.json" >> $GITHUB_STEP_SUMMARY
        echo "- 📝 language_stats.md" >> $GITHUB_STEP_SUMMARY
        echo "- 📖 README.md" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Language statistics have been successfully updated!" >> $GITHUB_STEP_SUMMARY
